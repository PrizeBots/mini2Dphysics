"use strict";var t=function(t,e){this.x=t,this.y=e};function e(){this.mDepth=0,this.mNormal=new t(0,0),this.mStart=new t(0,0),this.mEnd=new t(0,0)}function i(e,i,s,r){this.mCenter=e,this.mInertia=0,this.mInvMass=void 0!==i?i:1,this.mFriction=void 0!==s?s:.8,this.mRestitution=void 0!==r?r:.2,this.mVelocity=new t(0,0),0!==this.mInvMass?(this.mInvMass=1/this.mInvMass,this.mAcceleration=m.Core.mGravity):this.mAcceleration=new t(0,0),this.mAngle=0,this.mAngularVelocity=0,this.mAngularAcceleration=0,this.mBoundRadius=0,m.Core.mAllObjects.push(this)}t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.add=function(e){return new t(e.x+this.x,e.y+this.y)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.scale=function(e){return new t(this.x*e,this.y*e)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.rotate=function(e,i){var s=[],r=this.x-e.x,o=this.y-e.y;return s[0]=r*Math.cos(i)-o*Math.sin(i),s[1]=r*Math.sin(i)+o*Math.cos(i),s[0]+=e.x,s[1]+=e.y,new t(s[0],s[1])},t.prototype.normalize=function(){var e=this.length();return e>0&&(e=1/e),new t(this.x*e,this.y*e)},t.prototype.distance=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)},e.prototype.setDepth=function(t){this.mDepth=t},e.prototype.setNormal=function(t){this.mNormal=t},e.prototype.getDepth=function(){return this.mDepth},e.prototype.getNormal=function(){return this.mNormal},e.prototype.setInfo=function(t,e,i){this.mDepth=t,this.mNormal=e,this.mStart=i,this.mEnd=i.add(e.scale(t))},e.prototype.changeDir=function(){this.mNormal=this.mNormal.scale(-1);var t=this.mStart;this.mStart=this.mEnd,this.mEnd=t},i.prototype.updateMass=function(e){var i;i=0!==this.mInvMass?1/this.mInvMass:0,(i+=e)<=0?(this.mInvMass=0,this.mVelocity=new t(0,0),this.mAcceleration=new t(0,0),this.mAngularVelocity=0,this.mAngularAcceleration=0):(this.mInvMass=1/i,this.mAcceleration=m.Core.mGravity),this.updateInertia()},i.prototype.updateInertia=function(){},i.prototype.update=function(){if(m.Core.mMovement){var t=m.Core.mUpdateIntervalInSeconds;this.mVelocity=this.mVelocity.add(this.mAcceleration.scale(t)),this.move(this.mVelocity.scale(t)),this.mAngularVelocity+=this.mAngularAcceleration*t,this.rotate(this.mAngularVelocity*t)}var e=m.Core.mWidth,i=m.Core.mHeight;if(this.mCenter.x<0||this.mCenter.x>e||this.mCenter.y<0||this.mCenter.y>i){var s=m.Core.mAllObjects.indexOf(this);s>-1&&m.Core.mAllObjects.splice(s,1)}},i.prototype.boundTest=function(t){var e=t.mCenter.subtract(this.mCenter),i=this.mBoundRadius+t.mBoundRadius;return!(e.length()>i)};var s=function(e,s,r,o,n){i.call(this,e,r,o,n),this.mType="Circle",this.mRadius=s,this.mBoundRadius=s,this.mStartpoint=new t(e.x,e.y-s),this.updateInertia()};(r=Object.create(i.prototype)).constructor=s,s.prototype=r,s.prototype.move=function(t){return this.mStartpoint=this.mStartpoint.add(t),this.mCenter=this.mCenter.add(t),this},s.prototype.draw=function(t){t.beginPath(),t.arc(this.mCenter.x,this.mCenter.y,this.mRadius,0,2*Math.PI,!0),t.moveTo(this.mStartpoint.x,this.mStartpoint.y),t.lineTo(this.mCenter.x,this.mCenter.y),t.closePath(),t.stroke()},s.prototype.rotate=function(t){return this.mAngle+=t,this.mStartpoint=this.mStartpoint.rotate(this.mCenter,t),this},s.prototype.updateInertia=function(){0===this.mInvMass?this.mInertia=0:this.mInertia=1/this.mInvMass*(this.mRadius*this.mRadius)/12};var r,o=function(e,s,r,o,n,a){i.call(this,e,o,n,a),this.mType="Rectangle",this.mWidth=s,this.mHeight=r,this.mBoundRadius=Math.sqrt(s*s+r*r)/2,this.mVertex=[],this.mFaceNormal=[],this.mVertex[0]=new t(e.x-s/2,e.y-r/2),this.mVertex[1]=new t(e.x+s/2,e.y-r/2),this.mVertex[2]=new t(e.x+s/2,e.y+r/2),this.mVertex[3]=new t(e.x-s/2,e.y+r/2),this.mFaceNormal[0]=this.mVertex[1].subtract(this.mVertex[2]),this.mFaceNormal[0]=this.mFaceNormal[0].normalize(),this.mFaceNormal[1]=this.mVertex[2].subtract(this.mVertex[3]),this.mFaceNormal[1]=this.mFaceNormal[1].normalize(),this.mFaceNormal[2]=this.mVertex[3].subtract(this.mVertex[0]),this.mFaceNormal[2]=this.mFaceNormal[2].normalize(),this.mFaceNormal[3]=this.mVertex[0].subtract(this.mVertex[1]),this.mFaceNormal[3]=this.mFaceNormal[3].normalize(),this.updateInertia()};(r=Object.create(i.prototype)).constructor=o,o.prototype=r,o.prototype.rotate=function(t){var e;for(this.mAngle+=t,e=0;e<this.mVertex.length;e++)this.mVertex[e]=this.mVertex[e].rotate(this.mCenter,t);return this.mFaceNormal[0]=this.mVertex[1].subtract(this.mVertex[2]),this.mFaceNormal[0]=this.mFaceNormal[0].normalize(),this.mFaceNormal[1]=this.mVertex[2].subtract(this.mVertex[3]),this.mFaceNormal[1]=this.mFaceNormal[1].normalize(),this.mFaceNormal[2]=this.mVertex[3].subtract(this.mVertex[0]),this.mFaceNormal[2]=this.mFaceNormal[2].normalize(),this.mFaceNormal[3]=this.mVertex[0].subtract(this.mVertex[1]),this.mFaceNormal[3]=this.mFaceNormal[3].normalize(),this},o.prototype.move=function(t){var e;for(e=0;e<this.mVertex.length;e++)this.mVertex[e]=this.mVertex[e].add(t);return this.mCenter=this.mCenter.add(t),this},o.prototype.draw=function(t){t.save(),t.translate(this.mVertex[0].x,this.mVertex[0].y),t.rotate(this.mAngle),t.strokeRect(0,0,this.mWidth,this.mHeight),t.restore()},o.prototype.updateInertia=function(){0===this.mInvMass?this.mInertia=0:(this.mInertia=1/this.mInvMass*(this.mWidth*this.mWidth+this.mHeight*this.mHeight)/12,this.mInertia=1/this.mInertia)},s.prototype.collisionTest=function(t,e){return"Circle"===t.mType?this.collidedCircCirc(this,t,e):t.collidedRectCirc(this,e)},s.prototype.collidedCircCirc=function(e,i,s){var r=i.mCenter.subtract(e.mCenter),o=e.mRadius+i.mRadius,n=r.length();if(n>Math.sqrt(o*o))return!1;if(0!==n){var a=r.scale(-1).normalize().scale(i.mRadius);s.setInfo(o-n,r.normalize(),i.mCenter.add(a))}else e.mRadius>i.mRadius?s.setInfo(o,new t(0,-1),e.mCenter.add(new t(0,e.mRadius))):s.setInfo(o,new t(0,-1),i.mCenter.add(new t(0,i.mRadius)));return!0},o.prototype.collisionTest=function(t,e){return"Circle"===t.mType?this.collidedRectCirc(t,e):this.collidedRectRect(this,t,e)};var n=new function(){this.mSupportPoint=null,this.mSupportPointDist=0};o.prototype.findSupportPoint=function(t,e){var i;n.mSupportPointDist=-9999999,n.mSupportPoint=null;for(var s=0;s<this.mVertex.length;s++)(i=this.mVertex[s].subtract(e).dot(t))>0&&i>n.mSupportPointDist&&(n.mSupportPoint=this.mVertex[s],n.mSupportPointDist=i)},o.prototype.findAxisLeastPenetration=function(t,e){for(var i,s=999999,r=null,o=!0,a=0;o&&a<this.mFaceNormal.length;){var m=this.mFaceNormal[a].scale(-1),l=this.mVertex[a];t.findSupportPoint(m,l),(o=null!==n.mSupportPoint)&&n.mSupportPointDist<s&&(s=n.mSupportPointDist,r=a,i=n.mSupportPoint),a+=1}if(o){var c=this.mFaceNormal[r].scale(s);e.setInfo(s,this.mFaceNormal[r],i.add(c))}return o};var a,m,l=new e,c=new e;o.prototype.collidedRectRect=function(t,e,i){var s,r=!1;if((s=t.findAxisLeastPenetration(e,l))&&(r=e.findAxisLeastPenetration(t,c)))if(l.getDepth()<c.getDepth()){var o=l.getNormal().scale(l.getDepth());i.setInfo(l.getDepth(),l.getNormal(),l.mStart.subtract(o))}else i.setInfo(c.getDepth(),c.getNormal().scale(-1),c.mStart);return s&&r},o.prototype.collidedRectCirc=function(t,e){var i,s,r,o,n,a,m=!0,l=-99999,c=0;for(i=0;i<4;i++){if((r=(s=t.mCenter).subtract(this.mVertex[i]).dot(this.mFaceNormal[i]))>0){l=r,c=i,m=!1;break}r>l&&(l=r,c=i)}if(m)a=this.mFaceNormal[c].scale(t.mRadius),e.setInfo(t.mRadius-l,this.mFaceNormal[c],s.subtract(a));else{var h=s.subtract(this.mVertex[c]),u=this.mVertex[(c+1)%4].subtract(this.mVertex[c]),p=h.dot(u);if(p<0){if((o=h.length())>t.mRadius)return!1;a=(n=h.normalize()).scale(-t.mRadius),e.setInfo(t.mRadius-o,n,s.add(a))}else if(h=s.subtract(this.mVertex[(c+1)%4]),u=u.scale(-1),(p=h.dot(u))<0){if((o=h.length())>t.mRadius)return!1;a=(n=h.normalize()).scale(-t.mRadius),e.setInfo(t.mRadius-o,n,s.add(a))}else{if(!(l<t.mRadius))return!1;a=this.mFaceNormal[c].scale(t.mRadius),e.setInfo(t.mRadius-l,this.mFaceNormal[c],s.subtract(a))}}return!0},(m=m||{}).Physics=(a=function(e,i,s){if(0!==e.mInvMass||0!==i.mInvMass){m.Physics.mPositionalCorrectionFlag&&function(t,e,i){var s=t.mInvMass,r=e.mInvMass,o=i.getDepth()/(s+r)*.8,n=i.getNormal().scale(o);t.move(n.scale(-s)),e.move(n.scale(r))}(e,i,s);var r=s.getNormal(),o=s.mStart.scale(i.mInvMass/(e.mInvMass+i.mInvMass)),n=s.mEnd.scale(e.mInvMass/(e.mInvMass+i.mInvMass)),a=o.add(n),l=a.subtract(e.mCenter),c=a.subtract(i.mCenter),h=e.mVelocity.add(new t(-1*e.mAngularVelocity*l.y,e.mAngularVelocity*l.x)),u=i.mVelocity.add(new t(-1*i.mAngularVelocity*c.y,i.mAngularVelocity*c.x)).subtract(h),p=u.dot(r);if(!(p>0)){var d=Math.min(e.mRestitution,i.mRestitution),y=Math.min(e.mFriction,i.mFriction),f=l.cross(r),v=c.cross(r),b=-(1+d)*p;b/=e.mInvMass+i.mInvMass+f*f*e.mInertia+v*v*i.mInertia;var x=r.scale(b);e.mVelocity=e.mVelocity.subtract(x.scale(e.mInvMass)),i.mVelocity=i.mVelocity.add(x.scale(i.mInvMass)),e.mAngularVelocity-=f*b*e.mInertia,i.mAngularVelocity+=v*b*i.mInertia;var I=u.subtract(r.scale(u.dot(r)));I=I.normalize().scale(-1);var g=l.cross(I),C=c.cross(I),V=-(1+d)*u.dot(I)*y;(V/=e.mInvMass+i.mInvMass+g*g*e.mInertia+C*C*i.mInertia)>b&&(V=b),x=I.scale(V),e.mVelocity=e.mVelocity.subtract(x.scale(e.mInvMass)),i.mVelocity=i.mVelocity.add(x.scale(i.mInvMass)),e.mAngularVelocity-=g*V*e.mInertia,i.mAngularVelocity+=C*V*i.mInertia}}},{collision:function(){var t,i,s,r=new e;for(s=0;s<15;s++)for(t=0;t<m.Core.mAllObjects.length;t++)for(i=t+1;i<m.Core.mAllObjects.length;i++)m.Core.mAllObjects[t].boundTest(m.Core.mAllObjects[i])&&m.Core.mAllObjects[t].collisionTest(m.Core.mAllObjects[i],r)&&(r.getNormal().dot(m.Core.mAllObjects[i].mCenter.subtract(m.Core.mAllObjects[t].mCenter))<0&&r.changeDir(),a(m.Core.mAllObjects[t],m.Core.mAllObjects[i],r))},mPositionalCorrectionFlag:!0}),(m=m||{}).Core=function(){var e,i;e=document.getElementById("canvas"),i=e.getContext("2d"),e.height=450,e.width=800;var s,r,o=new t(0,20),n=Date.now(),a=0,l=[],c=function(){var t;for(t=0;t<l.length;t++)l[t].update(i)},u=function(){for(requestAnimationFrame(function(){u()}),s=Date.now(),r=s-n,n=s,a+=r,document.getElementById("uiEchoString").innerHTML='<p><b>Selected Object:</b>:</p><ul style="margin:-10px"><li>Id: '+h+"</li><li>Center: "+l[h].mCenter.x.toPrecision(3)+","+l[h].mCenter.y.toPrecision(3)+"</li><li>Angle: "+l[h].mAngle.toPrecision(3)+"</li><li>Velocity: "+l[h].mVelocity.x.toPrecision(3)+","+l[h].mVelocity.y.toPrecision(3)+"</li><li>AngluarVelocity: "+l[h].mAngularVelocity.toPrecision(3)+"</li><li>Mass: "+1/l[h].mInvMass.toPrecision(3)+"</li><li>Friction: "+l[h].mFriction.toPrecision(3)+"</li><li>Restitution: "+l[h].mRestitution.toPrecision(3)+"</li><li>Positional Correction: "+m.Physics.mPositionalCorrectionFlag+"</li><li>Movement: "+m.Core.mMovement+'</li></ul> <hr><p><b>Control</b>: of selected object</p><ul style="margin:-10px"><li><b>Num</b> or <b>Up/Down Arrow</b>: Select Object</li><li><b>WASD</b> + <b>QE</b>: Position [Move + Rotate]</li><li><b>IJKL</b> + <b>UO</b>: Velocities [Linear + Angular]</li><li><b>Z/X</b>: Mass [Decrease/Increase]</li><li><b>C/V</b>: Frictrion [Decrease/Increase]</li><li><b>B/N</b>: Restitution [Decrease/Increase]</li><li><b>M</b>: Positional Correction [On/Off]</li><li><b>,</b>: Movement [On/Off]</li></ul> <hr><b>F/G</b>: Spawn [Rectangle/Circle] at selected object<p><b>H</b>: Excite all objects</p><p><b>R</b>: Reset System</p><hr>',function(){var t;for(i.clearRect(0,0,800,450),t=0;t<l.length;t++)i.strokeStyle="blue",t===h&&(i.strokeStyle="red"),l[t].draw(i)}();a>=1/60*1e3;)a-=1/60*1e3,m.Physics.collision(),c()};return{initializeEngineCore:function(){u()},mAllObjects:l,mWidth:800,mHeight:450,mContext:i,mGravity:o,mUpdateIntervalInSeconds:1/60,mMovement:!0}}();var h=0