<canvas id="canvas"></canvas>
<script>
var Vec2=function(t,e){this.x=t,this.y=e};function CollisionInfo(){this.mDepth=0,this.mNormal=new Vec2(0,0),this.mStart=new Vec2(0,0),this.mEnd=new Vec2(0,0)}function RigidShape(t,e,i,n){this.mCenter=t,this.mInertia=0,this.mInvMass=void 0!==e?e:1,this.mFriction=void 0!==i?i:.8,this.mRestitution=void 0!==n?n:.2,this.mVelocity=new Vec2(0,0),0!==this.mInvMass?(this.mInvMass=1/this.mInvMass,this.mAcceleration=gEngine.Core.mGravity):this.mAcceleration=new Vec2(0,0),this.mAngle=0,this.mAngularVelocity=0,this.mAngularAcceleration=0,this.mBoundRadius=0,gEngine.Core.mAllObjects.push(this)}Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vec2.prototype.add=function(t){return new Vec2(t.x+this.x,t.y+this.y)},Vec2.prototype.subtract=function(t){return new Vec2(this.x-t.x,this.y-t.y)},Vec2.prototype.scale=function(t){return new Vec2(this.x*t,this.y*t)},Vec2.prototype.dot=function(t){return this.x*t.x+this.y*t.y},Vec2.prototype.cross=function(t){return this.x*t.y-this.y*t.x},Vec2.prototype.rotate=function(t,e){var i=[],n=this.x-t.x,o=this.y-t.y;return i[0]=n*Math.cos(e)-o*Math.sin(e),i[1]=n*Math.sin(e)+o*Math.cos(e),i[0]+=t.x,i[1]+=t.y,new Vec2(i[0],i[1])},Vec2.prototype.normalize=function(){var t=this.length();return t>0&&(t=1/t),new Vec2(this.x*t,this.y*t)},Vec2.prototype.distance=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)},CollisionInfo.prototype.setDepth=function(t){this.mDepth=t},CollisionInfo.prototype.setNormal=function(t){this.mNormal=t},CollisionInfo.prototype.getDepth=function(){return this.mDepth},CollisionInfo.prototype.getNormal=function(){return this.mNormal},CollisionInfo.prototype.setInfo=function(t,e,i){this.mDepth=t,this.mNormal=e,this.mStart=i,this.mEnd=i.add(e.scale(t))},CollisionInfo.prototype.changeDir=function(){this.mNormal=this.mNormal.scale(-1);var t=this.mStart;this.mStart=this.mEnd,this.mEnd=t},RigidShape.prototype.updateMass=function(t){var e;e=0!==this.mInvMass?1/this.mInvMass:0,(e+=t)<=0?(this.mInvMass=0,this.mVelocity=new Vec2(0,0),this.mAcceleration=new Vec2(0,0),this.mAngularVelocity=0,this.mAngularAcceleration=0):(this.mInvMass=1/e,this.mAcceleration=gEngine.Core.mGravity),this.updateInertia()},RigidShape.prototype.updateInertia=function(){},RigidShape.prototype.update=function(){if(gEngine.Core.mMovement){var t=gEngine.Core.mUpdateIntervalInSeconds;this.mVelocity=this.mVelocity.add(this.mAcceleration.scale(t)),this.move(this.mVelocity.scale(t)),this.mAngularVelocity+=this.mAngularAcceleration*t,this.rotate(this.mAngularVelocity*t)}var e=gEngine.Core.mWidth,i=gEngine.Core.mHeight;if(this.mCenter.x<0||this.mCenter.x>e||this.mCenter.y<0||this.mCenter.y>i){var n=gEngine.Core.mAllObjects.indexOf(this);n>-1&&gEngine.Core.mAllObjects.splice(n,1)}},RigidShape.prototype.boundTest=function(t){var e=t.mCenter.subtract(this.mCenter),i=this.mBoundRadius+t.mBoundRadius;return!(e.length()>i)};var Circle=function(t,e,i,n,o){RigidShape.call(this,t,i,n,o),this.mType="Circle",this.mRadius=e,this.mBoundRadius=e,this.mStartpoint=new Vec2(t.x,t.y-e),this.updateInertia()};(prototype=Object.create(RigidShape.prototype)).constructor=Circle,Circle.prototype=prototype,Circle.prototype.move=function(t){return this.mStartpoint=this.mStartpoint.add(t),this.mCenter=this.mCenter.add(t),this},Circle.prototype.draw=function(t){t.beginPath(),t.arc(this.mCenter.x,this.mCenter.y,this.mRadius,0,2*Math.PI,!0),t.moveTo(this.mStartpoint.x,this.mStartpoint.y),t.lineTo(this.mCenter.x,this.mCenter.y),t.closePath(),t.stroke()},Circle.prototype.rotate=function(t){return this.mAngle+=t,this.mStartpoint=this.mStartpoint.rotate(this.mCenter,t),this},Circle.prototype.updateInertia=function(){0===this.mInvMass?this.mInertia=0:this.mInertia=1/this.mInvMass*(this.mRadius*this.mRadius)/12};var prototype,Rectangle=function(t,e,i,n,o,s){RigidShape.call(this,t,n,o,s),this.mType="Rectangle",this.mWidth=e,this.mHeight=i,this.mBoundRadius=Math.sqrt(e*e+i*i)/2,this.mVertex=[],this.mFaceNormal=[],this.mVertex[0]=new Vec2(t.x-e/2,t.y-i/2),this.mVertex[1]=new Vec2(t.x+e/2,t.y-i/2),this.mVertex[2]=new Vec2(t.x+e/2,t.y+i/2),this.mVertex[3]=new Vec2(t.x-e/2,t.y+i/2),this.mFaceNormal[0]=this.mVertex[1].subtract(this.mVertex[2]),this.mFaceNormal[0]=this.mFaceNormal[0].normalize(),this.mFaceNormal[1]=this.mVertex[2].subtract(this.mVertex[3]),this.mFaceNormal[1]=this.mFaceNormal[1].normalize(),this.mFaceNormal[2]=this.mVertex[3].subtract(this.mVertex[0]),this.mFaceNormal[2]=this.mFaceNormal[2].normalize(),this.mFaceNormal[3]=this.mVertex[0].subtract(this.mVertex[1]),this.mFaceNormal[3]=this.mFaceNormal[3].normalize(),this.updateInertia()};(prototype=Object.create(RigidShape.prototype)).constructor=Rectangle,Rectangle.prototype=prototype,Rectangle.prototype.rotate=function(t){var e;for(this.mAngle+=t,e=0;e<this.mVertex.length;e++)this.mVertex[e]=this.mVertex[e].rotate(this.mCenter,t);return this.mFaceNormal[0]=this.mVertex[1].subtract(this.mVertex[2]),this.mFaceNormal[0]=this.mFaceNormal[0].normalize(),this.mFaceNormal[1]=this.mVertex[2].subtract(this.mVertex[3]),this.mFaceNormal[1]=this.mFaceNormal[1].normalize(),this.mFaceNormal[2]=this.mVertex[3].subtract(this.mVertex[0]),this.mFaceNormal[2]=this.mFaceNormal[2].normalize(),this.mFaceNormal[3]=this.mVertex[0].subtract(this.mVertex[1]),this.mFaceNormal[3]=this.mFaceNormal[3].normalize(),this},Rectangle.prototype.move=function(t){var e;for(e=0;e<this.mVertex.length;e++)this.mVertex[e]=this.mVertex[e].add(t);return this.mCenter=this.mCenter.add(t),this},Rectangle.prototype.draw=function(t){t.save(),t.translate(this.mVertex[0].x,this.mVertex[0].y),t.rotate(this.mAngle),t.strokeRect(0,0,this.mWidth,this.mHeight),t.restore()},Rectangle.prototype.updateInertia=function(){0===this.mInvMass?this.mInertia=0:(this.mInertia=1/this.mInvMass*(this.mWidth*this.mWidth+this.mHeight*this.mHeight)/12,this.mInertia=1/this.mInertia)},Circle.prototype.collisionTest=function(t,e){return"Circle"===t.mType?this.collidedCircCirc(this,t,e):t.collidedRectCirc(this,e)},Circle.prototype.collidedCircCirc=function(t,e,i){var n=e.mCenter.subtract(t.mCenter),o=t.mRadius+e.mRadius,s=n.length();if(s>Math.sqrt(o*o))return!1;if(0!==s){var r=n.scale(-1).normalize().scale(e.mRadius);i.setInfo(o-s,n.normalize(),e.mCenter.add(r))}else t.mRadius>e.mRadius?i.setInfo(o,new Vec2(0,-1),t.mCenter.add(new Vec2(0,t.mRadius))):i.setInfo(o,new Vec2(0,-1),e.mCenter.add(new Vec2(0,e.mRadius)));return!0},Rectangle.prototype.collisionTest=function(t,e){return"Circle"===t.mType?this.collidedRectCirc(t,e):this.collidedRectRect(this,t,e)};var SupportStruct=function(){this.mSupportPoint=null,this.mSupportPointDist=0},tmpSupport=new SupportStruct;Rectangle.prototype.findSupportPoint=function(t,e){var i;tmpSupport.mSupportPointDist=-9999999,tmpSupport.mSupportPoint=null;for(var n=0;n<this.mVertex.length;n++)(i=this.mVertex[n].subtract(e).dot(t))>0&&i>tmpSupport.mSupportPointDist&&(tmpSupport.mSupportPoint=this.mVertex[n],tmpSupport.mSupportPointDist=i)},Rectangle.prototype.findAxisLeastPenetration=function(t,e){for(var i,n=999999,o=null,s=!0,r=0;s&&r<this.mFaceNormal.length;){var a=this.mFaceNormal[r].scale(-1),m=this.mVertex[r];t.findSupportPoint(a,m),(s=null!==tmpSupport.mSupportPoint)&&tmpSupport.mSupportPointDist<n&&(n=tmpSupport.mSupportPointDist,o=r,i=tmpSupport.mSupportPoint),r+=1}if(s){var c=this.mFaceNormal[o].scale(n);e.setInfo(n,this.mFaceNormal[o],i.add(c))}return s};var gEngine,collisionInfoR1=new CollisionInfo,collisionInfoR2=new CollisionInfo;Rectangle.prototype.collidedRectRect=function(t,e,i){var n,o=!1;if((n=t.findAxisLeastPenetration(e,collisionInfoR1))&&(o=e.findAxisLeastPenetration(t,collisionInfoR2)))if(collisionInfoR1.getDepth()<collisionInfoR2.getDepth()){var s=collisionInfoR1.getNormal().scale(collisionInfoR1.getDepth());i.setInfo(collisionInfoR1.getDepth(),collisionInfoR1.getNormal(),collisionInfoR1.mStart.subtract(s))}else i.setInfo(collisionInfoR2.getDepth(),collisionInfoR2.getNormal().scale(-1),collisionInfoR2.mStart);return n&&o},Rectangle.prototype.collidedRectCirc=function(t,e){var i,n,o,s,r,a,m=!0,c=-99999,l=0;for(i=0;i<4;i++){if((o=(n=t.mCenter).subtract(this.mVertex[i]).dot(this.mFaceNormal[i]))>0){c=o,l=i,m=!1;break}o>c&&(c=o,l=i)}if(m)a=this.mFaceNormal[l].scale(t.mRadius),e.setInfo(t.mRadius-c,this.mFaceNormal[l],n.subtract(a));else{var h=n.subtract(this.mVertex[l]),u=this.mVertex[(l+1)%4].subtract(this.mVertex[l]),p=h.dot(u);if(p<0){if((s=h.length())>t.mRadius)return!1;a=(r=h.normalize()).scale(-t.mRadius),e.setInfo(t.mRadius-s,r,n.add(a))}else if(h=n.subtract(this.mVertex[(l+1)%4]),u=u.scale(-1),(p=h.dot(u))<0){if((s=h.length())>t.mRadius)return!1;a=(r=h.normalize()).scale(-t.mRadius),e.setInfo(t.mRadius-s,r,n.add(a))}else{if(!(c<t.mRadius))return!1;a=this.mFaceNormal[l].scale(t.mRadius),e.setInfo(t.mRadius-c,this.mFaceNormal[l],n.subtract(a))}}return!0},(gEngine=gEngine||{}).Physics=function(){var t=function(t,e,i){if(0!==t.mInvMass||0!==e.mInvMass){gEngine.Physics.mPositionalCorrectionFlag&&function(t,e,i){var n=t.mInvMass,o=e.mInvMass,s=i.getDepth()/(n+o)*.8,r=i.getNormal().scale(s);t.move(r.scale(-n)),e.move(r.scale(o))}(t,e,i);var n=i.getNormal(),o=i.mStart.scale(e.mInvMass/(t.mInvMass+e.mInvMass)),s=i.mEnd.scale(t.mInvMass/(t.mInvMass+e.mInvMass)),r=o.add(s),a=r.subtract(t.mCenter),m=r.subtract(e.mCenter),c=t.mVelocity.add(new Vec2(-1*t.mAngularVelocity*a.y,t.mAngularVelocity*a.x)),l=e.mVelocity.add(new Vec2(-1*e.mAngularVelocity*m.y,e.mAngularVelocity*m.x)).subtract(c),h=l.dot(n);if(!(h>0)){var u=Math.min(t.mRestitution,e.mRestitution),p=Math.min(t.mFriction,e.mFriction),d=a.cross(n),g=m.cross(n),f=-(1+u)*h;f/=t.mInvMass+e.mInvMass+d*d*t.mInertia+g*g*e.mInertia;var y=n.scale(f);t.mVelocity=t.mVelocity.subtract(y.scale(t.mInvMass)),e.mVelocity=e.mVelocity.add(y.scale(e.mInvMass)),t.mAngularVelocity-=d*f*t.mInertia,e.mAngularVelocity+=g*f*e.mInertia;var V=l.subtract(n.scale(l.dot(n)));V=V.normalize().scale(-1);var I=a.cross(V),v=m.cross(V),C=-(1+u)*l.dot(V)*p;(C/=t.mInvMass+e.mInvMass+I*I*t.mInertia+v*v*e.mInertia)>f&&(C=f),y=V.scale(C),t.mVelocity=t.mVelocity.subtract(y.scale(t.mInvMass)),e.mVelocity=e.mVelocity.add(y.scale(e.mInvMass)),t.mAngularVelocity-=I*C*t.mInertia,e.mAngularVelocity+=v*C*e.mInertia}}};return{collision:function(){var e,i,n,o=new CollisionInfo;for(n=0;n<15;n++)for(e=0;e<gEngine.Core.mAllObjects.length;e++)for(i=e+1;i<gEngine.Core.mAllObjects.length;i++)gEngine.Core.mAllObjects[e].boundTest(gEngine.Core.mAllObjects[i])&&gEngine.Core.mAllObjects[e].collisionTest(gEngine.Core.mAllObjects[i],o)&&(o.getNormal().dot(gEngine.Core.mAllObjects[i].mCenter.subtract(gEngine.Core.mAllObjects[e].mCenter))<0&&o.changeDir(),t(gEngine.Core.mAllObjects[e],gEngine.Core.mAllObjects[i],o))},mPositionalCorrectionFlag:!0}}(),(gEngine=gEngine||{}).Core=function(){var t,e;t=document.getElementById("canvas"),e=t.getContext("2d"),t.height=450,t.width=800;var i,n,o=new Vec2(0,20),s=Date.now(),r=0,a=[],m=function(){var t;for(t=0;t<a.length;t++)a[t].update(e)},c=function(){for(requestAnimationFrame(function(){c()}),i=Date.now(),n=i-s,s=i,r+=n,function(){var t;for(e.clearRect(0,0,800,450),t=0;t<a.length;t++)e.strokeStyle="#ccc",a[t].draw(e)}();r>=1/60*1e3;)r-=1/60*1e3,gEngine.Physics.collision(),m()};return{initializeEngineCore:function(){c()},mAllObjects:a,mWidth:800,mHeight:450,mContext:e,mGravity:o,mUpdateIntervalInSeconds:1/60,mMovement:!0}}()


/* global height, width, gEngine */
function MyGame() {
    var r1 = new Rectangle(new Vec2(500, 200), 400, 20, 0, 0.3, 0);
    r1.rotate(2.8);
    var r2 = new Rectangle(new Vec2(200, 400), 400, 20, 0, 1, 0.5);
    var r3 = new Rectangle(new Vec2(100, 200), 200, 20, 0);
    var r4 = new Rectangle(new Vec2(10, 360), 20, 100, 0, 0, 1);

    for (var i = 0; i < 10; i++) {
        var r1 = new Rectangle(new Vec2(Math.random() * gEngine.Core.mWidth, Math.random() * gEngine.Core.mHeight / 2), Math.random() * 50 + 10, Math.random() * 50 + 10, Math.random() * 30, Math.random(), Math.random());
        r1.mVelocity = new Vec2(Math.random() * 60 - 30, Math.random() * 60 - 30);
        var r1 = new Circle(new Vec2(Math.random() * gEngine.Core.mWidth, Math.random() * gEngine.Core.mHeight / 2), Math.random() * 20 + 10, Math.random() * 30, Math.random(), Math.random());
        r1.mVelocity = new Vec2(Math.random() * 60 - 30, Math.random() * 60 - 30);
    }
}


var gObjectNum = 0;
var game = new MyGame();
gEngine.Core.initializeEngineCore()
</script>